# Reference this view as omni_dbt__google_ads_campaign_performance
schema_label: ""

schema: omni_dbt
table_name: GOOGLE_ADS_CAMPAIGN_PERFORMANCE

dimensions:
  date:
    sql: '"DATE"'

  account:
    sql: '"ACCOUNT"'

  customer_id:
    sql: '"CUSTOMER_ID"'
    format: ID

  campaign:
    sql: '"CAMPAIGN"'

  campaign_id:
    sql: '"CAMPAIGN_ID"'
    format: ID

  conversion_action_name:
    sql: '"CONVERSION_ACTION_NAME"'

  spend:
    sql: '"SPEND"'

  impressions:
    sql: '"IMPRESSIONS"'

  clicks:
    sql: '"CLICKS"'

  conversions:
    sql: '"CONVERSIONS"'

  conversion_value:
    sql: '"CONVERSION_VALUE"'

  cpc:
    sql: '"CPC"'

  ctr:
    sql: '"CTR"'

  cpa:
    sql: '"CPA"'

  roas:
    sql: '"ROAS"'

  is_optimization_conversion:
    sql: '"IS_OPTIMIZATION_CONVERSION"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: google_ads_campaign_performance
  target_schema: PROD
  config:
    materialized: table
  code: |-
    {{ config(materialized = "table") }}

    -- Google Ads Campaign Performance
    -- Combines campaign spend with conversions WITHOUT duplication
    -- Uses ROW_NUMBER to assign spend only to first row per campaign/date
    -- Captures ALL spend (including Performance Max, Demand Gen, Video)

    WITH campaign_spend AS (
        SELECT * FROM {{ ref('int_google_campaign_spend') }}
    ),

    campaign_conversions AS (
        SELECT * FROM {{ ref('int_google_campaign_conversions') }}
    ),

    optimization_conv AS (
        SELECT * FROM {{ ref('optimization_conversions') }}
        WHERE platform = 'google'
    ),

    joined AS (
        SELECT 
            COALESCE(cs.date, cc.date) AS date,
            COALESCE(cs.account, cc.account) AS account,
            COALESCE(cs.customer_id, cc.customer_id) AS customer_id,
            COALESCE(cs.campaign, cc.campaign) AS campaign,
            COALESCE(cs.campaign_id, cc.campaign_id) AS campaign_id,
            cc.conversion_action_name,
            cs.spend,
            cs.impressions,
            cs.clicks,
            cc.conversions,
            cc.conversion_value,
            ROW_NUMBER() OVER (
                PARTITION BY 
                    COALESCE(cs.date, cc.date),
                    COALESCE(cs.customer_id, cc.customer_id),
                    COALESCE(cs.campaign_id, cc.campaign_id)
                ORDER BY cc.conversion_action_name NULLS LAST
            ) AS rn
        FROM campaign_spend cs
        FULL OUTER JOIN campaign_conversions cc
            ON cs.date = cc.date
            AND cs.customer_id = cc.customer_id
            AND cs.campaign_id = cc.campaign_id
    )

    SELECT 
        j.date,
        j.account,
        j.customer_id,
        j.campaign,
        j.campaign_id,
        j.conversion_action_name,
        CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END AS spend,
        CASE WHEN j.rn = 1 THEN j.impressions ELSE 0 END AS impressions,
        CASE WHEN j.rn = 1 THEN j.clicks ELSE 0 END AS clicks,
        COALESCE(j.conversions, 0) AS conversions,
        COALESCE(j.conversion_value, 0) AS conversion_value,
        div0(CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END, CASE WHEN j.rn = 1 THEN j.clicks ELSE 0 END) AS cpc,
        div0(CASE WHEN j.rn = 1 THEN j.clicks ELSE 0 END, CASE WHEN j.rn = 1 THEN j.impressions ELSE 0 END) * 100 AS ctr,
        div0(CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END, COALESCE(j.conversions, 0)) AS cpa,
        div0(COALESCE(j.conversion_value, 0), CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END) AS roas,
        CASE WHEN oc.optimization_conversion IS NOT NULL THEN TRUE ELSE FALSE END AS is_optimization_conversion
    FROM joined j
    LEFT JOIN optimization_conv oc
        ON j.account = oc.account
        AND j.conversion_action_name = oc.optimization_conversion
    ORDER BY 1 DESC, 2, 3, 4
  referenced_by: [ all_spend_by_account ]
