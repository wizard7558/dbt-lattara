# Reference this view as dbt_prod__google_ads_adgroup_performance
label: Google Ads Ad Group Performance
description: |
  Ad group-level Google Ads performance data with conversion action breakdown.
  Covers Search, Demand Gen, and Video campaigns (90% spend coverage).
  Performance Max excluded as it has no ad groups.

catalog: DBT
schema: PROD
table_name: GOOGLE_ADS_ADGROUP_PERFORMANCE

dimensions:
  date:
    sql: '"DATE"'
    label: Date
    timeframes: [ raw, date, week, month, quarter, year ]
    convert_tz: false

  account:
    sql: '"ACCOUNT"'
    label: Account

  customer_id:
    sql: '"CUSTOMER_ID"'
    format: ID
    hidden: true

  campaign:
    sql: '"CAMPAIGN"'
    label: Campaign

  campaign_id:
    sql: '"CAMPAIGN_ID"'
    format: ID
    hidden: true

  ad_group:
    sql: '"ADGROUP"'
    label: Ad Group

  ad_group_id:
    sql: '"AD_GROUP_ID"'
    format: ID
    hidden: true

  conversion_action_name:
    sql: '"CONVERSION_ACTION_NAME"'
    label: Conversion Action

  is_optimization_conversion:
    sql: '"IS_OPTIMIZATION_CONVERSION"'
    label: Is Optimization Conversion
    description: True if this conversion action is the primary optimization event
      for the account

  # Hidden base columns for aggregation
  spend:
    sql: '"SPEND"'
    hidden: true

  impressions:
    sql: '"IMPRESSIONS"'
    hidden: true

  clicks:
    sql: '"CLICKS"'
    hidden: true

  conversions:
    sql: '"CONVERSIONS"'
    hidden: true

  conversion_value:
    sql: '"CONVERSION_VALUE"'
    hidden: true

  opt_conv_value:
    sql: CASE WHEN "IS_OPTIMIZATION_CONVERSION" = TRUE THEN "CONVERSIONS" ELSE 0 END
    hidden: true

measures:
  count:
    aggregate_type: count

  total_spend:
    sql: ${spend}
    label: Spend
    format: usdcurrency_2
    aggregate_type: sum

  total_impressions:
    sql: ${impressions}
    label: Impressions
    format: number_0
    aggregate_type: sum

  total_clicks:
    sql: ${clicks}
    label: Clicks
    format: number_0
    aggregate_type: sum

  total_conversions:
    sql: ${conversions}
    label: Conversions
    format: number_2
    aggregate_type: sum

  optimization_conversions:
    sql: ${opt_conv_value}
    label: Optimization Conversions
    format: number_2
    description: Conversions from the primary optimization event for each account
    aggregate_type: sum

  total_conversion_value:
    sql: ${conversion_value}
    label: Conversion Value
    format: usdcurrency_2
    aggregate_type: sum

  cpc:
    sql: ${total_spend} / NULLIF(${total_clicks}, 0)
    label: CPC
    format: usdcurrency_2

  ctr:
    sql: ${total_clicks} / NULLIF(${total_impressions}, 0) * 100
    label: CTR
    format: percent_2

  cpm:
    sql: ${total_spend} / NULLIF(${total_impressions}, 0) * 1000
    label: CPM
    format: usdcurrency_2

  cpa:
    sql: ${total_spend} / NULLIF(${total_conversions}, 0)
    label: CPA
    format: usdcurrency_2

  cost_per_optimization_conversion:
    sql: ${total_spend} / NULLIF(${optimization_conversions}, 0)
    label: Cost per Optimization Conversion
    format: usdcurrency_2
    description: Cost per primary optimization conversion

  roas:
    sql: ${total_conversion_value} / NULLIF(${total_spend}, 0)
    label: ROAS
    format: number_2

  conversion_rate:
    sql: ${total_conversions} / NULLIF(${total_clicks}, 0) * 100
    label: Conversion Rate
    format: percent_2

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: google_ads_adgroup_performance
  target_schema: PROD
  config:
    materialized: table
  code: |-
    {{ config(materialized = "table") }}

    -- Google Ads Ad Group Performance
    -- Combines ad group spend with conversions WITHOUT duplication
    -- Uses ROW_NUMBER to assign spend only to first row per adgroup/date
    -- Captures Search, Demand Gen, and Video (Performance Max excluded - no ad groups)

    WITH adgroup_spend AS (
        SELECT * FROM {{ ref('int_google_adgroup_spend') }}
    ),

    adgroup_conversions AS (
        SELECT * FROM {{ ref('int_google_adgroup_conversions') }}
    ),

    optimization_conv AS (
        SELECT * FROM {{ ref('optimization_conversions') }}
        WHERE platform = 'google'
    ),

    joined AS (
        SELECT 
            COALESCE(ags.date, ac.date) AS date,
            COALESCE(ags.account, ac.account) AS account,
            COALESCE(ags.customer_id, ac.customer_id) AS customer_id,
            COALESCE(ags.campaign, ac.campaign) AS campaign,
            COALESCE(ags.campaign_id, ac.campaign_id) AS campaign_id,
            COALESCE(ags.adgroup, ac.adgroup) AS adgroup,
            COALESCE(ags.ad_group_id, ac.ad_group_id) AS ad_group_id,
            ac.conversion_action_name,
            ags.spend,
            ags.impressions,
            ags.clicks,
            ac.conversions,
            ac.conversion_value,
            ROW_NUMBER() OVER (
                PARTITION BY 
                    COALESCE(ags.date, ac.date),
                    COALESCE(ags.customer_id, ac.customer_id),
                    COALESCE(ags.ad_group_id, ac.ad_group_id)
                ORDER BY ac.conversion_action_name NULLS LAST
            ) AS rn
        FROM adgroup_spend ags
        FULL OUTER JOIN adgroup_conversions ac
            ON ags.date = ac.date
            AND ags.customer_id = ac.customer_id
            AND ags.ad_group_id = ac.ad_group_id
    )

    SELECT 
        j.date,
        j.account,
        j.customer_id,
        j.campaign,
        j.campaign_id,
        j.adgroup,
        j.ad_group_id,
        j.conversion_action_name,
        CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END AS spend,
        CASE WHEN j.rn = 1 THEN j.impressions ELSE 0 END AS impressions,
        CASE WHEN j.rn = 1 THEN j.clicks ELSE 0 END AS clicks,
        COALESCE(j.conversions, 0) AS conversions,
        COALESCE(j.conversion_value, 0) AS conversion_value,
        div0(CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END, CASE WHEN j.rn = 1 THEN j.clicks ELSE 0 END) AS cpc,
        div0(CASE WHEN j.rn = 1 THEN j.clicks ELSE 0 END, CASE WHEN j.rn = 1 THEN j.impressions ELSE 0 END) * 100 AS ctr,
        div0(CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END, COALESCE(j.conversions, 0)) AS cpa,
        div0(COALESCE(j.conversion_value, 0), CASE WHEN j.rn = 1 THEN j.spend ELSE 0 END) AS roas,
        CASE WHEN oc.optimization_conversion IS NOT NULL THEN TRUE ELSE FALSE END AS is_optimization_conversion
    FROM joined j
    LEFT JOIN optimization_conv oc
        ON j.account = oc.account
        AND j.conversion_action_name = oc.optimization_conversion
    ORDER BY 1 DESC, 2, 3, 4, 5
  referenced_by: [ all_ads_performance ]
